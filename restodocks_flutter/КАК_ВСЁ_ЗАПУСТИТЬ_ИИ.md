# Как сделать, чтобы нейросети выполняли задачи в приложении

Одна инструкция: что сделать по порядку, чтобы ИИ в приложении заработал (чеклисты, ТТК из Excel, продукты, чеки и т.д.).

---

## Кратко: что должно быть готово

1. **Проект Supabase** — база данных и приложение к ней подключаются.
2. **Секреты в Supabase** — ключи к нейросетям (GigaChat и/или Gemini для текста, OpenAI для фото).
3. **Edge Functions задеплоены** — код нейросетей запущен на серверах Supabase.
4. **Приложение знает адрес Supabase** — в приложении прописаны URL и ключ проекта (локально или на Vercel).

Ниже — каждый пункт по шагам.

---

## Часть 1. Проект Supabase

Если проект уже есть и приложение к нему подключается (логин, данные грузятся) — этот блок можно пропустить.

1. Зайди на [supabase.com](https://supabase.com) и войди в аккаунт.
2. **New project** → выбери организацию, введи имя проекта и пароль базы (сохрани пароль).
3. Дождись создания проекта (1–2 минуты).
4. Таблицы для Restodocks должны быть созданы (по инструкции из `SETUP_SUPABASE.md` или уже сделаны ранее). Если приложение уже работало с этим проектом — всё ок.

---

## Часть 2. Секреты для нейросетей (в Supabase)

Секреты — это ключи API. Они хранятся в Supabase и подставляются в Edge Functions при вызове. Пользователь их не видит.

**Где добавлять:** Supabase → твой проект → слева внизу **Project Settings** (шестерёнка) → в меню слева **Edge Functions** → вкладка **Secrets** (или **Environment variables** для функций).

Добавь по одному секрету (кнопка **Add new secret** / **New secret**):

| Имя секрета | Что вставить | Зачем |
|-------------|--------------|--------|
| **GIGACHAT_AUTH_KEY** | Строка в Base64 (см. ниже) | Текст: чеклисты, ТТК из Excel, продукты, КБЖУ, верификация. Бесплатный лимит для физлиц. |
| **GEMINI_API_KEY** | Ключ из [aistudio.google.com](https://aistudio.google.com) (Get API key) | Текст, если не используешь GigaChat. Бесплатный tier. |
| **OPENAI_API_KEY** | Ключ из [platform.openai.com](https://platform.openai.com) (API keys → Create) | Нужен для **фото**: чек по фото, ТТК из фото. Платно. |

**Как сделать GIGACHAT_AUTH_KEY:**  
В личном кабинете GigaChat (developers.sber.ru / gigachat.ai) возьми **Client ID** и **Client Secret**. Строка до кодирования: `ClientID:ClientSecret` (без пробелов, между ними одна двоеточие). Эту строку закодируй в Base64. В терминале на Mac:
```bash
echo -n "ТВОЙ_CLIENT_ID:ТВОЙ_CLIENT_SECRET" | base64
```
Скопируй вывод и вставь в значение секрета **GIGACHAT_AUTH_KEY**.

**Приоритет для текста:** если задан и GigaChat, и Gemini — по умолчанию используется GigaChat. Чтобы всегда использовать Gemini, добавь ещё один секрет: имя **AI_PROVIDER**, значение **gemini**.

---

## Часть 3. Деплой Edge Functions

Функции (чеклист, ТТК, продукты, чек, КБЖУ, верификация) должны быть задеплоены в твой проект Supabase. Делается из терминала один раз (или после обновления кода функций).

Подробная пошаговая инструкция с командами — в файле **`DEPLOY_FUNCTIONS_ИНСТРУКЦИЯ.md`** в этой же папке. Кратко:

1. **Войти в Supabase** (один раз):
   ```bash
   npx supabase login
   ```
   Откроется браузер — войди в аккаунт Supabase.

2. **Привязать проект** (один раз):  
   В [Supabase Dashboard](https://supabase.com/dashboard) → твой проект → **Project Settings** → **General** → скопируй **Reference ID**.  
   В терминале:
   ```bash
   cd /Users/masurfsker/Documents/Restodocks/Restodocks/restodocks_flutter
   npx supabase link --project-ref ВСТАВЬ_СЮДА_REFERENCE_ID
   ```

3. **Задеплоить все функции:**
   ```bash
   cd /Users/masurfsker/Documents/Restodocks/Restodocks/restodocks_flutter
   npx supabase functions deploy ai-generate-checklist
   npx supabase functions deploy ai-recognize-tech-card
   npx supabase functions deploy ai-recognize-tech-cards-batch
   npx supabase functions deploy ai-recognize-product
   npx supabase functions deploy ai-refine-nutrition
   npx supabase functions deploy ai-verify-product
   ```
   Для распознавания чека по фото (если нужно):
   ```bash
   npx supabase functions deploy ai-recognize-receipt
   ```

После успешного деплоя функции будут вызываться из приложения, а секреты (GIGACHAT_AUTH_KEY, OPENAI_API_KEY и т.д.) подхватятся автоматически.

---

## Часть 4. Приложение должно знать адрес Supabase

Приложение подключается к проекту по **URL** и **anon-ключу**. Без них оно не сможет ни авторизоваться, ни вызывать Edge Functions.

**Где взять URL и ключ:**  
Supabase → твой проект → **Project Settings** → **API**. Там будут:
- **Project URL** (например `https://xxxxx.supabase.co`) → это **SUPABASE_URL**
- **anon public** (длинный ключ `eyJ...`) → это **SUPABASE_ANON_KEY**

### Вариант А. Локальный запуск (тест на своём компьютере)

1. В папке `restodocks_flutter` создай или отредактируй файл **`.env`** (в корне папки, рядом с `pubspec.yaml`).
2. Внутри файла две строки (подставь свои значения из Supabase → API):
   ```
   SUPABASE_URL=https://твой-проект.supabase.co
   SUPABASE_ANON_KEY=eyJ...твой_anon_ключ...
   ```
3. Сохрани файл. Запусти приложение (например из Cursor/VS Code: Run → Run without debugging, или в терминале: `flutter run -d chrome` для web).
4. Приложение прочитает `.env` и подключится к твоему проекту. ИИ будет вызывать твои задеплоенные функции и твои секреты.

### Вариант Б. Сайт на Vercel (то, что открывают по ссылке)

1. Зайди в [vercel.com](https://vercel.com) → свой проект Restodocks.
2. **Settings** → **Environment Variables**.
3. Добавь две переменные (для Production и Preview):
   - **SUPABASE_URL** = твой Project URL из Supabase → API
   - **SUPABASE_ANON_KEY** = anon public из Supabase → API
4. Сделай **Redeploy** последнего деплоя (или новый push в репозиторий). При сборке Vercel подставит эти значения в приложение, и на сайте будет использоваться твой Supabase и твои Edge Functions с секретами.

---

## Часть 5. Проверка, что ИИ выполняет задачи в приложении

После того как сделаны части 1–4:

1. Открой приложение (локально или по ссылке Vercel).
2. Войди в аккаунт (если нужен логин).
3. Проверь любую фичу с ИИ:
   - **Чеклисты** — кнопка вроде «Создать по запросу» / «Сгенерировать» → введи текст → должен создаться чеклист с пунктами (без чата, сразу результат в списке).
   - **ТТК** — «ТТК из Excel» / загрузка файла → должны распознаться карточки и появиться экран проверки или форма ТТК с заполненными полями.
   - **Номенклатура** — добавление продукта или «Проверить по ИИ» → подставятся название, категория, КБЖУ и т.д. в карточку продукта.

Если что-то не срабатывает: проверь, что секреты в Supabase заданы, функции задеплоены (часть 2 и 3), а приложение подключается к тому же проекту (часть 4). В логах Supabase (Edge Functions → логи вызовов) можно увидеть ошибки при вызове нейросетей.

---

## Итог: минимальный список действий

1. Supabase: проект есть, таблицы созданы.
2. Supabase → Edge Functions → Secrets: добавлены **GIGACHAT_AUTH_KEY** и/или **GEMINI_API_KEY** (для текста), при необходимости **OPENAI_API_KEY** (для фото).
3. Терминал: `npx supabase login` → `npx supabase link --project-ref ...` → `npx supabase functions deploy ai-...` (все нужные функции).
4. Приложение: в локальном `.env` или в Vercel Environment Variables заданы **SUPABASE_URL** и **SUPABASE_ANON_KEY** от этого же проекта.
5. Открыть приложение и проверить одну-две кнопки с ИИ — результат должен появляться в интерфейсе (чеклисты, ТТК, продукты), а не в отдельном чате.

После этого нейросети будут именно **выполнять задачи в приложении** (создавать и заполнять данные), а не просто «отвечать в чате».
