# План реализации ТЗ: Модуль интеллектуального импорта, сверки цен и очистки номенклатуры

## Текущее состояние
- **product_upload_screen.dart**: 5 способов загрузки (файл, вставка, AI-текст, интеллектуальный Excel, простой Excel)
- **intelligent_product_import_service.dart**: импорт Excel с fuzzy matching, нормализацией, переводами
- **nomenclature_screen.dart**: экран номенклатуры, загрузка через _UploadProgressDialog (показывает окно подтверждения на весь список)
- **Проблема**: при импорте есть диалоги на неоднозначные сопоставления, нет единого экрана модерации

## Архитектура решения

### 1. Источники данных
| Источник | Реализация |
|----------|------------|
| Excel/CSV | Парсинг через `excel` пакет с raw values (без ошибок форматирования) |
| Текст (Copy-Paste) | Поле TextField — ИИ распознаёт названия, цены, ед. изм. из строки/тире |

### 2. Поток данных (отложенная модерация)
```
[Файл/Текст] → Парсинг (raw) → ИИ: колонки Name/Price/Unit → Буфер (память)
                                                                    ↓
[Экран модерации (Review)] ← ← ← ← ← ← ← ← ← ← ← ← ← ← ← ← ← ← ← ← ←
    Категории: исправление названий | аномальные цены | обновление цен
    Кнопки: Принять всё | точечное подтверждение/отклонение
                                                                    ↓
[Подтверждение] → Запись в БД (UUID не меняется при обновлении цен)
```

### 3. Edge Functions
| Функция | Назначение |
|---------|------------|
| **ai-parse-product-list** (новая) | Всеядный парсинг: на вход сырые строки (из файла или текста) → JSON `[{name, price?, unit?}]` |
| **ai-normalize-product-names** (новая) | Батч исправления названий: опечатки, сленг |
| **ai-find-duplicates** (новая) | Поиск похожих названий в номенклатуре |
| ai-verify-product | Существующая — точечная верификация |

### 4. Модели данных
```dart
// Элемент буфера модерации (ещё не в БД)
class ModerationItem {
  String name;           // исходное или исправленное
  double? price;
  String? unit;
  String? normalizedName; // ИИ предложил
  double? suggestedPrice; // при аномалии
  String? existingProductId; // если найден в базе
  double? existingPrice;    // старая цена для сравнения
  ModerationCategory category; // nameFix | priceAnomaly | priceUpdate | new
  bool approved;          // пользователь подтвердил
}

enum ModerationCategory { nameFix, priceAnomaly, priceUpdate, newProduct }
```

---

## Этапы реализации

### Этап 1: Парсинг и буфер
- [ ] Excel/CSV: читать raw values, передавать строки в ИИ
- [ ] Текст: поле ввода → ИИ парсит список
- [ ] Edge Function `ai-parse-product-list`
- [ ] Модель `ModerationItem` и буфер в памяти

### Этап 2: Экран модерации
- [ ] `ImportReviewScreen` с вкладками/секциями по категориям
- [ ] Список: исправление названий (ИИ)
- [ ] Список: аномальные цены
- [ ] Список: обновление цен (старая | новая)
- [ ] Кнопка «Принять всё»
- [ ] Чекбоксы/кнопки точечного подтверждения
- [ ] Запись в БД только после «Сохранить»

### Этап 3: Поиск дубликатов
- [ ] Кнопка «Поиск дубликатов» на экране Номенклатуры
- [ ] Edge Function `ai-find-duplicates`
- [ ] Экран списка дубликатов

### Этап 4: Управление дубликатами
- [ ] «Удалить все дубликаты» (оставить эталон)
- [ ] Ручной выбор для удаления
- [ ] Предпросмотр перед применением в БД
