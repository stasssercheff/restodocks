# Безопасность Restodocks

## Обзор

В Restodocks данные регистрации и сессии обрабатываются с учётом требований к защите:

- **Сервер (Supabase):** чувствительные поля хранятся и передаются защищённо.
- **Мобильные приложения (iOS/Android):** сессия и идентификаторы хранятся в защищённом хранилище и при необходимости подгружаются в память при запуске.

## Хранение паролей (bcrypt)

- Пароли **никогда** не сохраняются в открытом виде.
- При регистрации (владелец, сотрудник) пароль хешируется через **bcrypt** (`BCrypt.hashpw` + `BCrypt.gensalt`) и в БД записывается только хеш в `employees.password_hash`.
- При входе проверка выполняется через **bcrypt** (`BCrypt.checkpw(plain, storedHash)`).
- Используется пакет [`bcrypt`](https://pub.dev/packages/bcrypt) (Dart).

**Миграция:** если в БД ранее хранились пароли в открытом виде, их нужно сбросить или мигрировать на bcrypt (например, при первом успешном входе по старой схеме перезаписать `password_hash` хешем и отключить старую проверку).

## Сессия и идентификаторы (клиент)

- Идентификаторы сессии (`employee_id`, `establishment_id`) сохраняются в **SecureStorageService**:
  - **iOS / Android / desktop:** [Flutter Secure Storage](https://pub.dev/packages/flutter_secure_storage) (Keychain / Encrypted Shared Preferences и аналог для desktop). Данные хранятся в зашифрованном виде.
  - **Web:** `SharedPreferences` (в браузере полноценное secure storage недоступно).
- При запуске приложения сессия восстанавливается из этого хранилища; при выходе — ключи удаляются.

## Supabase: шифрование и передача

- **Encryption at rest:** Supabase (PostgreSQL) использует шифрование данных в состоянии хранения. Детали — в [документации Supabase](https://supabase.com/docs/guides/platform/security).
- **Передача:** взаимодействие с Supabase идёт по HTTPS. Токены и ключи не логируются и не попадают в билд (например, через `config.json` при деплое, без захардкоженных секретов в репозитории).

## Рекомендации

1. **Смена пароля:** реализовать отдельный поток «Смена пароля» (хешировать новый пароль через bcrypt и обновлять только `password_hash`). Метод `updateEmployee` намеренно не меняет пароль.
2. **Секреты:** не коммитить `SUPABASE_ANON_KEY` / `SUPABASE_URL` в репозиторий; использовать переменные окружения и runtime `config.json` на деплое.
3. **Audit:** периодически проверять доступ к таблицам (RLS, роли) и актуальность зависимостей (`bcrypt`, `flutter_secure_storage`, `supabase_flutter`).
