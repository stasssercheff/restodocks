# ИИ в Restodocks: стоимость, модели, работа по всему миру

## Платно ли?

**Да.** Функции с нейросетями идут через **OpenAI API** (вызовы из Supabase Edge Functions). Оплачивается не подписка в приложении, а **использование API**:

- Деньги списываются с вашего аккаунта **OpenAI** (или с биллинга Supabase, если вы настроите прокси).
- Оплата по факту: за количество запросов и объём текста (токены) / за анализ изображений.

Приложение само по себе не списывает деньги — только ваш backend (Edge Functions) дергает OpenAI, и за это платит владелец ключа (вы или ваша компания).

---

## Какие нейросети используются

Сейчас в Edge Functions используются модели **OpenAI**:

| Функция | Модель | Зачем |
|--------|--------|--------|
| ТТК из фото | **GPT-4o** | Анализ изображения карточки, точное извлечение полей по колонкам таблицы |
| Чек из фото | **GPT-4o** | Анализ фото чека, извлечение позиций |
| ТТК из Excel | **GPT-4o-mini** | Только текст (таблица уже распарсена), маппинг в поля ТТК |
| Генерация чеклиста | **GPT-4o-mini** | Текст по запросу |
| Распознавание продукта | **GPT-4o-mini** | Нормализация названия, категория, единица |
| Уточнение КБЖУ | **GPT-4o-mini** | Текст: дополнение/уточнение КБЖУ по названию продукта |

- **GPT-4o** — мультимодальная (текст + изображения), нужна для «фото → структурированные данные».
- **GPT-4o-mini** — быстрая и дешевая модель для чисто текстовых задач.

Альтернативы на будущее: те же сценарии можно перевести на **Claude** (Anthropic), **Gemini** (Google) или **Azure OpenAI** — для этого нужно будет заменить вызовы в Edge Functions и, при необходимости, формат запросов/ответов.

---

## Примерная стоимость (OpenAI)

Цены у OpenAI меняются, актуальные — на [openai.com/pricing](https://openai.com/pricing). Порядок величин:

- **GPT-4o** (включая картинки): заметно дороже за запрос, но один запрос «ТТК из фото» или «чек из фото» — обычно доли доллара (зависит от размера ответа).
- **GPT-4o-mini**: существенно дешевле; генерация чеклиста, продукт, КБЖУ, ТТК из Excel — копейки за запрос при умеренном использовании.

Итого: при небольшом и среднем количестве пользователей расходы на ИИ чаще всего небольшие; при большом трафике имеет смысл смотреть биллинг OpenAI и при необходимости ограничивать вызовы или кэшировать ответы.

---

## Работа по всему миру

- **OpenAI API** доступен во многих странах. Есть ограничения по юрисдикциям (список и правила см. в [документации OpenAI](https://platform.openai.com/docs)); для части регионов нужна отдельная настройка или партнёр.
- Чтобы сервис работал **глобально** и был устойчив к ограничениям в отдельных странах, можно:
  1. **Azure OpenAI** — тот же GPT, но через Microsoft, с другими правилами доступности по странам.
  2. **Резервный провайдер** — в коде Edge Functions завести выбор провайдера (например, по переменной окружения) и при недоступности OpenAI вызывать другую модель (Claude, Gemini и т.д.).
  3. **Региональные ключи** — для разных регионов использовать разные ключи (OpenAI / Azure / др.) через конфиг или Vault.

Сейчас в коде зашит только **OpenAI**; добавление второго провайдера — это замена `fetch` в соответствующих Edge Functions на вызов другого API и адаптация формата ответа под текущий контракт приложения.

---

## Где хранить ключи

- **OPENAI_API_KEY** задаётся в Supabase (секреты Edge Functions), не в приложении.
- Инструкция: `restodocks_flutter/supabase/functions/README.md` и `SETUP_SUPABASE.md`.

Так ключ не попадает в клиент и не светится в репозитории.
