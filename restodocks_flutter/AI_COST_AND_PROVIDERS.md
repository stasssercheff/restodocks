# ИИ в Restodocks: стоимость, модели, работа по всему миру

## Платно ли?

**На старте можно обойтись без оплаты.** В Edge Functions включён выбор провайдера:

- **GigaChat (приоритет):** при заданном `GIGACHAT_AUTH_KEY` все **текстовые** задачи (чеклист, продукт, КБЖУ, верификация, ТТК из Excel) идут в GigaChat. Для физлиц — **1 000 000 токенов в год бесплатно**.
- **OpenAI:** нужен для задач с **картинками** (чек из фото, ТТК из фото). Если задан только `OPENAI_API_KEY` — и текст, и картинки идут в OpenAI (оплата по факту за токены и изображения).

Приложение само по себе не списывает деньги — платит владелец ключа (GigaChat и/или OpenAI).

---

## Какие нейросети используются

Сейчас в Edge Functions используются модели **OpenAI**:

| Функция | Модель | Зачем |
|--------|--------|--------|
| ТТК из фото | **GPT-4o** | Анализ изображения карточки, точное извлечение полей по колонкам таблицы |
| Чек из фото | **GPT-4o** | Анализ фото чека, извлечение позиций |
| ТТК из Excel | **GPT-4o-mini** | Только текст (таблица уже распарсена), маппинг в поля ТТК |
| Генерация чеклиста | **GPT-4o-mini** | Текст по запросу |
| Распознавание продукта | **GPT-4o-mini** | Нормализация названия, категория, единица |
| Уточнение КБЖУ | **GPT-4o-mini** | Текст: дополнение/уточнение КБЖУ по названию продукта |
| Верификация продуктов | **GPT-4o-mini** | Цена, КБЖУ, нормализация названия по списку |

- **GPT-4o** — мультимодальная (текст + изображения), нужна для «фото → структурированные данные».
- **GPT-4o-mini** — быстрая и дешевая модель для чисто текстовых задач.

Альтернативы на будущее: те же сценарии можно перевести на **Claude** (Anthropic), **Gemini** (Google), **GigaChat**, **Yandex GPT** или **Azure OpenAI** — для этого нужно будет заменить вызовы в Edge Functions и, при необходимости, формат запросов/ответов.

---

## Примерная стоимость (OpenAI)

Актуальные цены всегда смотрите на [openai.com/pricing](https://openai.com/pricing). Ориентиры (могут меняться):

| Модель | Вход (за 1 млн токенов) | Выход (за 1 млн токенов) | Изображения |
|--------|--------------------------|---------------------------|-------------|
| **GPT-4o** | ~\$2.50 | ~\$10 | ~\$0.00286 за картинку |
| **GPT-4o-mini** | ~\$0.15 | ~\$0.60 | — |

- **GPT-4o**: один запрос «ТТК из фото» или «чек из фото» — обычно несколько центов (зависит от размера ответа и числа картинок).
- **GPT-4o-mini**: генерация чеклиста, продукт, КБЖУ, верификация, ТТК из Excel — доли цента за запрос при умеренном размере ввода/вывода.

Итого: при небольшом и среднем количестве пользователей расходы на ИИ чаще всего небольшие; при большом трафике имеет смысл смотреть биллинг OpenAI и при необходимости ограничивать вызовы или кэшировать ответы.

---

## Бесплатные и более дешёвые варианты: GigaChat и Yandex GPT

### GigaChat (Сбер)

- **Бесплатно для физлиц**: **1 000 000 токенов в год** (лимит раз в 12 месяцев):
  - 900 000 — GigaChat 2 Lite (текст),
  - 50 000 — GigaChat 2 Pro,
  - 50 000 — GigaChat 2 Max.
- **Мультимодальность**: GigaChat Pro умеет анализировать изображения (таблицы, текст на фото) — подходит для «ТТК из фото» и «чек из фото».
- Платные пакеты — в рублях (например, 5 млн токенов Lite — от 1 000 ₽).
- Документация и тарифы: [developers.sber.ru — GigaChat API](https://developers.sber.ru/docs/ru/gigachat/api/tariffs).

Чтобы использовать в Restodocks: в Edge Functions вместо вызова OpenAI нужно вызывать API GigaChat (другой URL, авторизация, формат запросов/ответов). Можно сделать выбор провайдера по переменной окружения (например, `AI_PROVIDER=openai` или `gigachat`).

### Yandex GPT (Yandex Cloud)

- **Платно**, но часто **дешевле** OpenAI: порядка **0,6 ₽ за 1000 токенов** (цифры могут меняться).
- Есть программа грантов **Yandex Cloud Boost AI** (до 1 млн ₽ на разработку).
- Модели: YandexGPT, YandexGPT-lite, YandexGPT 4 Pro / Lite (длинный контекст, рассуждения). Работа с изображениями — через **Yandex Vision** или обновлённые возможности в продуктах Яндекса (в API сценарии могут отличаться).
- Документация: [Yandex Cloud — Yandex GPT](https://cloud.yandex.ru/docs/yandexgpt/).

Чтобы использовать в Restodocks: добавить в Edge Functions вызовы API Yandex Cloud (IAM-токен или API-ключ), адаптировать формат под текущий контракт приложения (JSON на вход/выход).

### Итог

| Вариант | Условия | Подходит для |
|--------|--------|----------------|
| **OpenAI** (текущий) | Платно, $ за токены | Любой регион, максимум возможностей |
| **GigaChat** | 1 млн токенов/год бесплатно (физлица), потом пакеты в ₽ | РФ, экономия, в т.ч. «фото → данные» |
| **Yandex GPT** | Платно в ₽, часто дешевле OpenAI, гранты | РФ/СНГ, интеграция с Yandex Cloud |

Код сейчас рассчитан только на OpenAI; добавление GigaChat или Yandex GPT — это отдельная реализация вызовов в каждой Edge Function (или общий слой «провайдер ИИ» с разными бэкендами).

---

## Работа по всему миру

- **OpenAI API** доступен во многих странах. Есть ограничения по юрисдикциям (список и правила см. в [документации OpenAI](https://platform.openai.com/docs)); для части регионов нужна отдельная настройка или партнёр.
- Чтобы сервис работал **глобально** и был устойчив к ограничениям в отдельных странах, можно:
  1. **Azure OpenAI** — тот же GPT, но через Microsoft, с другими правилами доступности по странам.
  2. **Резервный провайдер** — в коде Edge Functions завести выбор провайдера (например, по переменной окружения) и при недоступности OpenAI вызывать другую модель (Claude, Gemini и т.д.).
  3. **Региональные ключи** — для разных регионов использовать разные ключи (OpenAI / Azure / др.) через конфиг или Vault.

Сейчас в коде зашит только **OpenAI**; добавление второго провайдера — это замена `fetch` в соответствующих Edge Functions на вызов другого API и адаптация формата ответа под текущий контракт приложения.

---

## Где хранить ключи

- **OPENAI_API_KEY** задаётся в Supabase (секреты Edge Functions), не в приложении.
- Инструкция: `restodocks_flutter/supabase/functions/README.md` и `SETUP_SUPABASE.md`.

Так ключ не попадает в клиент и не светится в репозитории.
