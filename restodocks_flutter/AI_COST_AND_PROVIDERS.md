# ИИ в Restodocks: стоимость, модели, работа по всему миру

## Платно ли?

**На старте можно обойтись без оплаты.** В Edge Functions включён выбор провайдера для **текста** (чеклист, продукт, КБЖУ, верификация, ТТК из Excel). Для **фото** (чек, ТТК из фото) пока только OpenAI.

| Провайдер | Бесплатно на старте? | Секрет в Supabase |
|-----------|----------------------|-------------------|
| **GigaChat** | Да, 1 млн токенов/год (физлица) | `GIGACHAT_AUTH_KEY` (Base64 от ClientID:ClientSecret) |
| **Google Gemini** | Да, лимиты бесплатного tier, ключ без карты | `GEMINI_API_KEY` (ключ из [aistudio.google.com](https://aistudio.google.com)) |
| **OpenAI** | Нет, оплата по факту | `OPENAI_API_KEY` |
| **Claude (Anthropic)** | Нет, API платный | `ANTHROPIC_API_KEY` |
| **Yandex GPT** | Гранты/триал в Yandex Cloud | Пока не подключён (можно добавить по аналогии) |

Приоритет текстовых задач: если задан `AI_PROVIDER` — используется он; иначе GigaChat → Gemini → Claude → OpenAI (по первому заданному ключу). Фото — только OpenAI.

---

## Какие нейросети используются

Сейчас в Edge Functions используются модели **OpenAI**:

| Функция | Модель | Зачем |
|--------|--------|--------|
| ТТК из фото | **GPT-4o** | Анализ изображения карточки, точное извлечение полей по колонкам таблицы |
| Чек из фото | **GPT-4o** | Анализ фото чека, извлечение позиций |
| ТТК из Excel | **GPT-4o-mini** | Только текст (таблица уже распарсена), маппинг в поля ТТК |
| Генерация чеклиста | **GPT-4o-mini** | Текст по запросу |
| Распознавание продукта | **GPT-4o-mini** | Нормализация названия, категория, единица |
| Уточнение КБЖУ | **GPT-4o-mini** | Текст: дополнение/уточнение КБЖУ по названию продукта |
| Верификация продуктов | **GPT-4o-mini** | Цена, КБЖУ, нормализация названия по списку |

- **GPT-4o** — мультимодальная (текст + изображения), нужна для «фото → структурированные данные».
- **GPT-4o-mini** — быстрая и дешевая модель для чисто текстовых задач.

**Уже подключены в общем слое** (`_shared/ai_provider.ts`): GigaChat, OpenAI, **Google Gemini**, **Anthropic Claude**. Текстовые Edge Functions автоматически используют выбранный провайдер. Yandex GPT можно добавить по той же схеме (IAM-токен или API-ключ в Yandex Cloud).

---

## Примерная стоимость (OpenAI)

Актуальные цены всегда смотрите на [openai.com/pricing](https://openai.com/pricing). Ориентиры (могут меняться):

| Модель | Вход (за 1 млн токенов) | Выход (за 1 млн токенов) | Изображения |
|--------|--------------------------|---------------------------|-------------|
| **GPT-4o** | ~\$2.50 | ~\$10 | ~\$0.00286 за картинку |
| **GPT-4o-mini** | ~\$0.15 | ~\$0.60 | — |

- **GPT-4o**: один запрос «ТТК из фото» или «чек из фото» — обычно несколько центов (зависит от размера ответа и числа картинок).
- **GPT-4o-mini**: генерация чеклиста, продукт, КБЖУ, верификация, ТТК из Excel — доли цента за запрос при умеренном размере ввода/вывода.

Итого: при небольшом и среднем количестве пользователей расходы на ИИ чаще всего небольшие; при большом трафике имеет смысл смотреть биллинг OpenAI и при необходимости ограничивать вызовы или кэшировать ответы.

---

## Бесплатные и более дешёвые варианты: GigaChat и Yandex GPT

### GigaChat (Сбер)

- **Бесплатно для физлиц**: **1 000 000 токенов в год** (лимит раз в 12 месяцев):
  - 900 000 — GigaChat 2 Lite (текст),
  - 50 000 — GigaChat 2 Pro,
  - 50 000 — GigaChat 2 Max.
- **Мультимодальность**: GigaChat Pro умеет анализировать изображения (таблицы, текст на фото) — подходит для «ТТК из фото» и «чек из фото».
- Платные пакеты — в рублях (например, 5 млн токенов Lite — от 1 000 ₽).
- Документация и тарифы: [developers.sber.ru — GigaChat API](https://developers.sber.ru/docs/ru/gigachat/api/tariffs).

Чтобы использовать в Restodocks: в Edge Functions вместо вызова OpenAI нужно вызывать API GigaChat (другой URL, авторизация, формат запросов/ответов). Можно сделать выбор провайдера по переменной окружения (например, `AI_PROVIDER=openai` или `gigachat`).

### Yandex GPT (Yandex Cloud)

- **Платно**, но часто **дешевле** OpenAI: порядка **0,6 ₽ за 1000 токенов** (цифры могут меняться).
- Есть программа грантов **Yandex Cloud Boost AI** (до 1 млн ₽ на разработку).
- Модели: YandexGPT, YandexGPT-lite, YandexGPT 4 Pro / Lite (длинный контекст, рассуждения). Работа с изображениями — через **Yandex Vision** или обновлённые возможности в продуктах Яндекса (в API сценарии могут отличаться).
- Документация: [Yandex Cloud — Yandex GPT](https://cloud.yandex.ru/docs/yandexgpt/).

Чтобы использовать в Restodocks: добавить в Edge Functions вызовы API Yandex Cloud (IAM-токен или API-ключ), адаптировать формат под текущий контракт приложения (JSON на вход/выход).

### Google Gemini (уже в коде)

- **Бесплатный tier:** лимиты по запросам/токенам в день, ключ из [Google AI Studio](https://aistudio.google.com), карта не нужна.
- В Supabase задать секрет `GEMINI_API_KEY` — текстовые задачи пойдут в Gemini (если не задан GigaChat или не указан `AI_PROVIDER=gigachat`).

### Claude (Anthropic) (уже в коде)

- **API платный**, бесплатного tier для API нет. Ключ в [console.anthropic.com](https://console.anthropic.com).
- Секрет `ANTHROPIC_API_KEY` — можно выставить `AI_PROVIDER=claude`, чтобы текст шёл в Claude.

### Итог

| Вариант | Условия | Подходит для |
|--------|--------|----------------|
| **GigaChat** | 1 млн токенов/год бесплатно (физлица) | РФ, бесплатный старт |
| **Gemini** | Бесплатный tier, ключ без карты | Любой регион, бесплатный старт |
| **OpenAI** | Платно, $ за токены | Фото + текст, максимум возможностей |
| **Claude** | Платно | Альтернатива OpenAI по тексту |
| **Yandex GPT** | Платно в ₽, гранты | РФ/СНГ (пока не в коде) |

---

## Работа по всему миру

- **OpenAI API** доступен во многих странах. Есть ограничения по юрисдикциям (список и правила см. в [документации OpenAI](https://platform.openai.com/docs)); для части регионов нужна отдельная настройка или партнёр.
- Чтобы сервис работал **глобально** и был устойчив к ограничениям в отдельных странах, можно:
  1. **Azure OpenAI** — тот же GPT, но через Microsoft, с другими правилами доступности по странам.
  2. **Резервный провайдер** — в коде Edge Functions завести выбор провайдера (например, по переменной окружения) и при недоступности OpenAI вызывать другую модель (Claude, Gemini и т.д.).
  3. **Региональные ключи** — для разных регионов использовать разные ключи (OpenAI / Azure / др.) через конфиг или Vault.

Сейчас в коде зашит только **OpenAI**; добавление второго провайдера — это замена `fetch` в соответствующих Edge Functions на вызов другого API и адаптация формата ответа под текущий контракт приложения.

---

## Где хранить ключи

Все ключи задаются в **Supabase → Project Settings → Edge Functions → Secrets** (или через `supabase secrets set`). В приложении ключей нет.

- `GIGACHAT_AUTH_KEY` — GigaChat (Base64)
- `GEMINI_API_KEY` — Google AI Studio
- `OPENAI_API_KEY` — OpenAI (обязателен для фото)
- `ANTHROPIC_API_KEY` — Claude
- `AI_PROVIDER` — опционально: `gigachat` | `openai` | `gemini` | `claude`

Подробнее: `restodocks_flutter/supabase/functions/README.md` и `SETUP_SUPABASE.md`.
